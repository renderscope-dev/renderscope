name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Web App (Next.js)
  # ──────────────────────────────────────────────
  web:
    name: Web — Lint, Type Check & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci
        working-directory: .

      - name: Lint (ESLint)
        run: npm run lint

      - name: Type check (TypeScript)
        run: npm run typecheck

      - name: Run tests
        run: npm test -- --passWithNoTests

      - name: Build (static export)
        run: npm run build

  # ──────────────────────────────────────────────
  # Job 2: npm Package (renderscope-ui)
  # ──────────────────────────────────────────────
  npm-package:
    name: npm Package — Lint, Type Check & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/renderscope-ui

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci
        working-directory: .

      - name: Lint (ESLint)
        run: npm run lint

      - name: Type check (TypeScript)
        run: npm run typecheck

      - name: Run tests
        run: npm test -- --passWithNoTests

      - name: Build
        run: npm run build

  # ──────────────────────────────────────────────
  # Job 3: Python Package (renderscope)
  # ──────────────────────────────────────────────
  python-package:
    name: Python — Lint, Type Check & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    defaults:
      run:
        working-directory: python

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: python/pyproject.toml

      - name: Install package with dev dependencies
        run: pip install -e ".[dev]"

      - name: Lint (Ruff — check)
        run: ruff check .

      - name: Format check (Ruff — format)
        run: ruff format --check .

      - name: Type check (mypy)
        run: mypy src/renderscope

      - name: Run tests
        run: pytest --tb=short -q

  # ──────────────────────────────────────────────
  # Job 4: Data Validation
  # ──────────────────────────────────────────────
  validate-data:
    name: Validate Data Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install validation dependencies
        run: pip install jsonschema

      - name: Validate JSON data against schemas
        run: python scripts/validate_data.py
